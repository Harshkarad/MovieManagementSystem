<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking History - Movie Ticket System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Base Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f8f9fa;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        h1 {
            font-size: 1.5rem;
            color: #e63946;
        }

        .user-controls {
            display: flex;
            gap: 10px;
        }

        button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover {
            opacity: 0.9;
        }

        #loginBtn {
            background-color: #457b9d;
            color: white;
        }

        #registerBtn {
            background-color: #1d3557;
            color: white;
        }

        .btn-home {
            padding: 8px 15px;
            background-color: #457b9d;
            color: white;
            border-radius: 4px;
            text-decoration: none;
            margin-right: 10px;
            transition: background-color 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .btn-home:hover {
            background-color: #1d3557;
        }

        .nav-links {
            display: flex;
            gap: 15px;
            margin: 20px 0;
        }

        .nav-link {
            padding: 8px 15px;
            text-decoration: none;
            color: #333;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .nav-link:hover,
        .nav-link.active {
            background-color: #e63946;
            color: white;
        }

        .nav-link i {
            margin-right: 5px;
        }

        .page-title {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #e63946;
            padding-bottom: 5px;
        }

        /* Booking History Cards */
        .booking-cards {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .booking-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }

        .booking-card:hover {
            transform: translateY(-5px);
        }

        .booking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .booking-id {
            font-weight: bold;
            color: #e63946;
        }

        .booking-date {
            color: #666;
            font-size: 0.9rem;
        }

        .booking-status {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .status-confirmed {
            background-color: #d4edda;
            color: #155724;
        }

        .status-cancelled {
            background-color: #f8d7da;
            color: #721c24;
        }

        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .booking-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        @media (min-width: 768px) {
            .booking-content {
                flex-direction: row;
            }
        }

        .booking-poster {
            width: 100%;
            max-width: 150px;
            height: auto;
            border-radius: 5px;
            object-fit: cover;
        }

        .booking-details {
            flex: 1;
        }

        .booking-movie-title {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #333;
        }

        .booking-info {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        @media (min-width: 576px) {
            .booking-info {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 992px) {
            .booking-info {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .booking-info-item {
            font-size: 0.9rem;
        }

        .booking-info-item strong {
            display: block;
            color: #666;
            margin-bottom: 3px;
        }

        .booking-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-action {
            padding: 8px 15px;
            border-radius: 4px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .btn-print {
            background-color: #457b9d;
            color: white;
            border: none;
        }

        .btn-print:hover {
            background-color: #1d3557;
        }

        .btn-review {
            background-color: #f8f9fa;
            color: #28a745;
            border: 1px solid #28a745;
        }

        .btn-review:hover {
            background-color: #28a745;
            color: white;
        }

        .btn-rate {
            background-color: #f8f9fa;
            color: #28a745;
            border: 1px solid #28a745;
        }

        .btn-rate:hover {
            background-color: #28a745;
            color: white;
        }

        /* Review Section */
        .review-section {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #28a745;
        }

        .review-section h4 {
            margin-bottom: 10px;
            color: #333;
        }

        .star-rating {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }

        .star-rating i {
            font-size: 1.5rem;
            color: #ccc;
            cursor: pointer;
            transition: color 0.2s;
        }

        .star-rating i:hover,
        .star-rating i.active {
            color: #ffc107;
        }

        .review-textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-height: 100px;
            margin-bottom: 10px;
            font-family: inherit;
        }

        .review-buttons {
            display: flex;
            gap: 10px;
        }

        .btn-submit-review {
            background-color: #28a745;
            color: white;
            border: none;
        }

        .btn-submit-review:hover {
            background-color: #218838;
        }

        .btn-cancel-review {
            background-color: #f8f9fa;
            color: #dc3545;
            border: 1px solid #dc3545;
        }

        .btn-cancel-review:hover {
            background-color: #dc3545;
            color: white;
        }

        /* No Bookings Message */
        .no-bookings {
            text-align: center;
            padding: 50px 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .no-bookings i {
            font-size: 3rem;
            color: #6c757d;
            margin-bottom: 20px;
        }

        .no-bookings h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .no-bookings p {
            color: #6c757d;
            margin-bottom: 20px;
        }

        /* Filter Controls */
        .filter-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }

        .filter-label {
            font-weight: 500;
            margin-right: 5px;
        }

        .filter-select {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #ddd;
            background-color: white;
        }

        .filter-btn {
            padding: 8px 15px;
            background-color: #e63946;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .filter-btn:hover {
            background-color: #c1121f;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 30px;
            gap: 5px;
        }

        .page-item {
            list-style: none;
        }

        .page-link {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            color: #333;
            text-decoration: none;
            transition: all 0.3s;
        }

        .page-link:hover {
            background-color: #f1f1f1;
        }

        .page-item.active .page-link {
            background-color: #e63946;
            color: white;
            border-color: #e63946;
        }

        .page-item.disabled .page-link {
            color: #6c757d;
            pointer-events: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-ticket-alt"></i> Movie Ticket System</h1>
            <div class="user-controls">
                <a href="/user-home" class="btn-home"><i class="fas fa-home"></i> Home</a>
                <th:block th:if="${userId == null}">
                    <button id="loginBtn">Login</button>
                    <button id="registerBtn">Register</button>
                </th:block>
                <th:block th:unless="${userId == null}">
                    <a th:href="@{/profile/{id}(id=${userId})}" class="btn-home"><i class="fas fa-user"></i> Profile</a>
                </th:block>
            </div>
        </header>

        <main class="content">
            <h1 class="page-title">Booking History</h1>

            <!-- <div class="nav-links">
                <a href="/user-home" class="nav-link"><i class="fas fa-film"></i> Movies</a>
                <a href="/booking-history" class="nav-link active"><i class="fas fa-history"></i> Booking History</a>
                <a href="/user-profile" class="nav-link"><i class="fas fa-user"></i> Profile</a>
            </div> -->

            <div class="filter-controls">
                <span class="filter-label">Filter by:</span>
                <select class="filter-select" id="statusFilter">
                    <option value="all">All Statuses</option>
                    <option value="confirmed">Confirmed</option>
                    <option value="cancelled">Cancelled</option>
                    <option value="pending">Pending</option>
                </select>
                <select class="filter-select" id="timeFilter">
                    <option value="all">All Time</option>
                    <option value="upcoming">Upcoming</option>
                    <option value="past">Past</option>
                </select>
                <button class="filter-btn" id="applyFilter">Apply</button>
            </div>

            <!-- Booking Cards - Dynamic Content -->
            <div class="booking-cards">
                <div class="booking-card" th:each="booking : ${bookings}">
                    <div class="booking-header">
                        <span class="booking-id" th:text="'Booking ID: ' + ${booking.bookingReference}">Booking
                            ID</span>
                        <span class="booking-date"
                            th:text="'Booked on: ' + ${#temporals.format(booking.bookingTime, 'MMMM dd, yyyy')}">Booked
                            on</span>
                        <span class="booking-status">Status</span> <!--th:classappend="${booking.paymentStatus == 'CONFIRMED'} ? 'status-confirmed' : 
                            (${booking.paymentStatus == 'CANCELLED'} ? 'status-cancelled' : 'status-pending')"
                            th:text="${booking.paymentStatus}"-->
                    </div>
                    <div class="booking-content">
                        <img th:src="${booking.screening.movies.poster}" alt="Movie Poster" class="booking-poster"
                            onerror="this.src='https://via.placeholder.com/150x225'">
                        <div class="booking-details">
                            <h3 class="booking-movie-title" th:text="${booking.screening.movies.title}">Movie Title</h3>
                            <div class="booking-info">
                                <div class="booking-info-item">
                                    <strong>Theater</strong>
                                    <span th:text="${booking.screening.theater.theatreName}">Theater Name</span>
                                </div>
                                <div class="booking-info-item">
                                    <strong>Date & Time</strong>
                                    <span>Show Time</span>
                                    <!--th:text="${#temporals.format(booking.screening.time, 'MMMM dd, yyyy \'at\' h:mm a')}"-->
                                </div>
                                <div class="booking-info-item">
                                    <strong>Screen</strong>
                                    <span th:text="${booking.screening.screen}">Screen Number</span>
                                </div>
                                <div class="booking-info-item">
                                    <strong>Seats</strong>
                                    <span th:text="${#strings.listJoin(booking.seats, ', ')}">Seat Numbers</span>
                                </div>
                                <div class="booking-info-item">
                                    <strong>Tickets</strong>
                                    <span th:text="${booking.numberOfTickets}">Number of Tickets</span>
                                </div>
                                <div class="booking-info-item">
                                    <strong>Total Paid</strong>
                                    <span th:text="'$' + ${#numbers.formatDecimal(booking.totalAmount, 1, 2)}">Total
                                        Amount</span>
                                    <span th:if="${booking.paymentStatus == 'CANCELLED'}"> (Refunded)</span>
                                </div>
                            </div>
                            <div class="booking-actions">
                                <button class="btn-action btn-print"
                                    th:data-booking-ref="${booking.bookingReference}"><i class="fas fa-print"></i> Print
                                    Ticket</button>
                                <button class="btn-action btn-review">
                                    <i class="fas fa-edit"></i> Write Review
                                </button>
                                <button class="btn-action btn-rate"
                                    th:if="${booking.paymentStatus == 'CONFIRMED' and booking.screening.time lt T(java.time.LocalDateTime).now()}">
                                    <i class="fas fa-star"></i> Rate Movie
                                </button>
                            </div>

                            <!-- Review Section -->
                            <div class="review-section">
                                <h4>Write Your Review</h4>
                                <form th:action="@{/submit-review}" method="post" class="review-form">
                                    <input type="hidden" name="movieId" th:value="${booking.screening.movies.id}">
                                    <input type="hidden" name="userId" th:value="${userId}"> <!-- Add this line -->
                                    <div class="star-rating">
                                        <i class="fas fa-star" data-rating="1"></i>
                                        <i class="fas fa-star" data-rating="2"></i>
                                        <i class="fas fa-star" data-rating="3"></i>
                                        <i class="fas fa-star" data-rating="4"></i>
                                        <i class="fas fa-star" data-rating="5"></i>
                                        <input type="hidden" name="rating" id="rating-input" value="0">
                                    </div>
                                    <textarea class="review-textarea" name="comment"
                                        placeholder="Share your thoughts about the movie..."></textarea>
                                    <div class="review-buttons">
                                        <button type="submit" class="btn-action btn-submit-review">
                                            <i class="fas fa-check"></i> Submit Review
                                        </button>
                                        <button type="button" class="btn-action btn-cancel-review">
                                            <i class="fas fa-times"></i> Cancel
                                        </button>
                                    </div>
                                </form>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

            <!-- No Bookings Message (hidden by default) -->
            <div class="no-bookings" id="noBookingsMessage" style="display: none;">
                <i class="fas fa-ticket-alt"></i>
                <h3>No Bookings Found</h3>
                <p>You haven't made any bookings yet. Browse our movies and book your tickets now!</p>
                <a href="/user-home" class="btn-home"><i class="fas fa-film"></i> Browse Movies</a>
            </div>

            <ul class="pagination">
                <li class="page-item disabled">
                    <a class="page-link" href="#" tabindex="-1">Previous</a>
                </li>
                <li class="page-item active">
                    <a class="page-link" href="#">1</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="#">2</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="#">3</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="#">Next</a>
                </li>
            </ul>
        </main>
    </div>

    <script>
        // Filter functionality
        document.getElementById('applyFilter').addEventListener('click', function () {
            const statusFilter = document.getElementById('statusFilter').value;
            const timeFilter = document.getElementById('timeFilter').value;

            // Get all booking cards
            const bookingCards = document.querySelectorAll('.booking-card');
            let visibleCards = 0;

            // Get current date for time filtering
            const currentDate = new Date();

            bookingCards.forEach(card => {
                const statusElement = card.querySelector('.booking-status');
                const dateTimeElement = card.querySelector('.booking-info-item:nth-child(2)');

                // Get status from class
                let status = '';
                if (statusElement.classList.contains('status-confirmed')) {
                    status = 'confirmed';
                } else if (statusElement.classList.contains('status-cancelled')) {
                    status = 'cancelled';
                } else if (statusElement.classList.contains('status-pending')) {
                    status = 'pending';
                }

                // Get date from text (this is simplified - in real app you'd parse properly)
                const dateTimeText = dateTimeElement.textContent.trim();
                const showDate = new Date(dateTimeText); // Simplified - would need proper parsing

                // Apply filters
                const statusMatch = statusFilter === 'all' || status === statusFilter;
                let timeMatch = true;

                if (timeFilter === 'upcoming') {
                    timeMatch = showDate > currentDate;
                } else if (timeFilter === 'past') {
                    timeMatch = showDate <= currentDate;
                }

                if (statusMatch && timeMatch) {
                    card.style.display = 'block';
                    visibleCards++;
                } else {
                    card.style.display = 'none';
                }
            });

            // Show no bookings message if no cards are visible
            const noBookingsMessage = document.getElementById('noBookingsMessage');
            if (visibleCards === 0) {
                noBookingsMessage.style.display = 'block';
            } else {
                noBookingsMessage.style.display = 'none';
            }
        });

        // Print ticket functionality
        document.querySelectorAll('.btn-print').forEach(button => {
            button.addEventListener('click', function () {
                const bookingRef = this.getAttribute('data-booking-ref');
                // Open ticket in a new window
                window.open(`/print-ticket?bookingReference=${encodeURIComponent(bookingRef)}`, '_blank');
            });
        });

        // Write Review functionality
        document.querySelectorAll('.btn-review').forEach(button => {
            button.addEventListener('click', function () {
                const reviewSection = this.closest('.booking-details').querySelector('.review-section');
                // Toggle the review section
                if (reviewSection.style.display === 'block') {
                    reviewSection.style.display = 'none';
                } else {
                    // Hide all other review sections first
                    document.querySelectorAll('.review-section').forEach(section => {
                        section.style.display = 'none';
                    });
                    reviewSection.style.display = 'block';
                }
            });
        });

        // Star rating functionality
        document.querySelectorAll('.star-rating i').forEach(star => {
            star.addEventListener('click', function () {
                const rating = parseInt(this.getAttribute('data-rating'));
                const starContainer = this.parentElement;
                const ratingInput = starContainer.querySelector('#rating-input');

                // Highlight selected stars
                starContainer.querySelectorAll('i').forEach((s, index) => {
                    if (index < rating) {
                        s.classList.add('active');
                    } else {
                        s.classList.remove('active');
                    }
                });

                // Update the hidden input value
                ratingInput.value = rating;
            });
        });


        // Submit review functionality
        document.querySelectorAll('.btn-submit-review').forEach(button => {
            // button.addEventListener('click', function () {
            //     const reviewSection = this.closest('.review-section');
            //     const starRating = reviewSection.querySelectorAll('.star-rating i.active').length;
            //     const reviewText = reviewSection.querySelector('.review-textarea').value;

            //     if (starRating === 0) {
            //         alert('Please select a star rating');
            //         return;
            //     }

            //     if (reviewText.trim() === '') {
            //         alert('Please write your review');
            //         return;
            //     }

            //     // In a real app, you would submit this to your backend
            //     alert(`Thank you for your ${starRating}-star review!\n\nYour review: "${reviewText}"`);

            //     // Hide the review section
            //     reviewSection.style.display = 'none';

            //     // Clear the form
            //     reviewSection.querySelectorAll('.star-rating i').forEach(star => {
            //         star.classList.remove('active');
            //     });
            //     reviewSection.querySelector('.review-textarea').value = '';
            // });
        });

        // Cancel review functionality
        document.querySelectorAll('.btn-cancel-review').forEach(button => {
            button.addEventListener('click', function () {
                const reviewSection = this.closest('.review-section');

                // Hide the review section
                reviewSection.style.display = 'none';

                // Clear the form
                const starContainer = reviewSection.querySelector('.star-rating');
                starContainer.querySelectorAll('i').forEach(star => {
                    star.classList.remove('active');
                });
                starContainer.querySelector('#rating-input').value = '0';
                reviewSection.querySelector('.review-textarea').value = '';
            });
        });

        // Rate movie functionality
        document.querySelectorAll('.btn-rate').forEach(button => {
            button.addEventListener('click', function () {
                const bookingCard = this.closest('.booking-card');
                const movieTitle = bookingCard.querySelector('.booking-movie-title').textContent;

                const rating = prompt(`Rate ${movieTitle} (1-5 stars):`);
                if (rating && rating >= 1 && rating <= 5) {
                    alert(`Thank you for rating ${movieTitle} with ${rating} stars!`);
                    // In a real app, this would submit the rating to the server
                    this.disabled = true;
                    this.style.opacity = '0.6';
                    this.style.cursor = 'not-allowed';
                    this.innerHTML = '<i class="fas fa-check"></i> Rated';
                }
            });
        });

        // Login/Register buttons
        document.getElementById('loginBtn').addEventListener('click', function () {
            alert('Login functionality would open a login modal');
        });

        document.getElementById('registerBtn').addEventListener('click', function () {
            alert('Register functionality would open a registration modal');
        });
    </script>
</body>

</html>