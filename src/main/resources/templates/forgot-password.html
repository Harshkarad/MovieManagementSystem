<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MovieHub - Forgot Password</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .password-container {
            max-width: 500px;
            margin: 5rem auto;
            padding: 2rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }
        
        .password-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .password-header i {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        
        .password-header h2 {
            color: var(--dark-color);
            font-weight: 600;
        }
        
        .password-header p {
            color: #7f8c8d;
        }
        
        .btn-reset {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            width: 100%;
            border-radius: 5px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-reset:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }
        
        .btn-reset:active {
            transform: translateY(0);
        }
        
        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.25);
        }
        
        .input-group-text {
            background-color: var(--light-color);
        }
        
        .step {
            display: none;
        }
        
        .step.active {
            display: block;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .otp-input {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
        }
        
        .otp-input input {
            width: 50px;
            height: 50px;
            text-align: center;
            font-size: 1.2rem;
            border: 2px solid #ddd;
            border-radius: 5px;
        }
        
        .otp-input input:focus {
            border-color: var(--primary-color);
            outline: none;
        }
        
        .back-to-login {
            text-align: center;
            margin-top: 1rem;
        }
        
        .timer {
            color: var(--danger-color);
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
        }
        
        /* Responsive adjustments */
        @media (max-width: 576px) {
            .password-container {
                margin: 2rem auto;
                padding: 1.5rem;
            }
            
            .otp-input input {
                width: 40px;
                height: 40px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <div class="password-container">
                    <div class="password-header">
                        <i class="fas fa-lock"></i>
                        <h2>Forgot Password</h2>
                        <p>Enter your email to reset your password</p>
                    </div>
                    
                    <!-- Step 1: Email Verification -->
                    <div class="step active" id="step1">
                        <div th:if="${error}" class="alert alert-danger">
                            <i class="fas fa-exclamation-circle"></i> <span th:text="${error}"></span>
                        </div>
                        <div th:if="${success}" class="alert alert-success">
                            <i class="fas fa-check-circle"></i> <span th:text="${success}"></span>
                        </div>
                        
                        <form id="emailForm">
                            <div class="mb-3">
                                <label for="email" class="form-label">Email Address</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                                    <input type="email" class="form-control" id="email" name="email" placeholder="Enter your registered email" required>
                                </div>
                                <div class="form-text">We'll send an OTP to this email</div>
                            </div>
                            <button type="submit" class="btn btn-reset" id="sendOtpBtn">
                                <i class="fas fa-paper-plane"></i> Send OTP
                            </button>
                        </form>
                    </div>
                    
                    <!-- Step 2: OTP Verification -->
                    <div class="step" id="step2">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> We've sent a 6-digit OTP to your email
                        </div>
                        <div id="otpError" class="alert alert-danger d-none">
                            <i class="fas fa-exclamation-circle"></i> <span id="otpErrorText"></span>
                        </div>
                        
                        <form id="otpForm">
                            <div class="otp-input">
                                <input type="text" maxlength="1" class="form-control otp-digit" data-index="1" autocomplete="off">
                                <input type="text" maxlength="1" class="form-control otp-digit" data-index="2" autocomplete="off">
                                <input type="text" maxlength="1" class="form-control otp-digit" data-index="3" autocomplete="off">
                                <input type="text" maxlength="1" class="form-control otp-digit" data-index="4" autocomplete="off">
                                <input type="text" maxlength="1" class="form-control otp-digit" data-index="5" autocomplete="off">
                                <input type="text" maxlength="1" class="form-control otp-digit" data-index="6" autocomplete="off">
                            </div>
                            <input type="hidden" id="fullOtp" name="otp">
                            
                            <div class="timer" id="timer">02:00</div>
                            
                            <button type="button" class="btn btn-link" id="resendOtpBtn" disabled>
                                <i class="fas fa-sync-alt"></i> Resend OTP (<span id="resendCountdown">120</span>s)
                            </button>
                            
                            <button type="submit" class="btn btn-reset mt-2" id="verifyOtpBtn">
                                <i class="fas fa-check"></i> Verify OTP
                            </button>
                        </form>
                    </div>
                    
                    <!-- Step 3: New Password -->
                    <div class="step" id="step3">
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i> OTP verified successfully!
                        </div>
                        <div id="passwordError" class="alert alert-danger d-none">
                            <i class="fas fa-exclamation-circle"></i> <span id="passwordErrorText"></span>
                        </div>
                        
                        <form id="passwordForm">
                            <div class="mb-3">
                                <label for="newPassword" class="form-label">New Password</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                    <input type="password" class="form-control" id="newPassword" name="newPassword" placeholder="Enter new password" required>
                                    <button class="btn btn-outline-secondary toggle-password" type="button">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <div class="form-text">Minimum 8 characters with at least 1 number and 1 special character</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="confirmPassword" class="form-label">Confirm Password</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                    <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" placeholder="Confirm new password" required>
                                    <button class="btn btn-outline-secondary toggle-password" type="button">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-reset" id="resetPasswordBtn">
                                <i class="fas fa-save"></i> Reset Password
                            </button>
                        </form>
                    </div>
                    
                    <!-- Step 4: Success Message -->
                    <div class="step" id="step4">
                        <div class="alert alert-success text-center">
                            <i class="fas fa-check-circle fa-3x mb-3" style="color: var(--success-color);"></i>
                            <h3>Password Reset Successful!</h3>
                            <p>Your password has been updated successfully.</p>
                            <a th:href="@{/}" class="btn btn-reset mt-3">
                                <i class="fas fa-sign-in-alt"></i> Back to Login
                            </a>
                        </div>
                    </div>
                    
                    <div class="back-to-login">
                        <a th:href="@{/}" class="text-decoration-none">
                            <i class="fas fa-arrow-left"></i> Back to Login
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const emailForm = document.getElementById('emailForm');
            const otpForm = document.getElementById('otpForm');
            const passwordForm = document.getElementById('passwordForm');
            const sendOtpBtn = document.getElementById('sendOtpBtn');
            const verifyOtpBtn = document.getElementById('verifyOtpBtn');
            const resetPasswordBtn = document.getElementById('resetPasswordBtn');
            const resendOtpBtn = document.getElementById('resendOtpBtn');
            const otpError = document.getElementById('otpError');
            const passwordError = document.getElementById('passwordError');
            const fullOtp = document.getElementById('fullOtp');
            const otpDigits = document.querySelectorAll('.otp-digit');
            const timerElement = document.getElementById('timer');
            const resendCountdown = document.getElementById('resendCountdown');
            
            // Toggle password visibility
            document.querySelectorAll('.toggle-password').forEach(button => {
                button.addEventListener('click', function() {
                    const input = this.parentElement.querySelector('input');
                    const icon = this.querySelector('i');
                    const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
                    input.setAttribute('type', type);
                    icon.classList.toggle('fa-eye');
                    icon.classList.toggle('fa-eye-slash');
                });
            });
            
            // OTP input handling
            otpDigits.forEach((digit, index) => {
                digit.addEventListener('input', function() {
                    if (this.value.length === 1) {
                        if (index < otpDigits.length - 1) {
                            otpDigits[index + 1].focus();
                        }
                    }
                });
                
                digit.addEventListener('keydown', function(e) {
                    if (e.key === 'Backspace' && this.value.length === 0) {
                        if (index > 0) {
                            otpDigits[index - 1].focus();
                        }
                    }
                });
            });
            
            // Step navigation
            function goToStep(stepNumber) {
                document.querySelectorAll('.step').forEach(step => {
                    step.classList.remove('active');
                });
                document.getElementById(`step${stepNumber}`).classList.add('active');
            }
            
            // Timer functionality
            let timerInterval;
            let secondsLeft = 120;
            
            function startTimer() {
                clearInterval(timerInterval);
                secondsLeft = 120;
                updateTimerDisplay();
                
                timerInterval = setInterval(() => {
                    secondsLeft--;
                    updateTimerDisplay();
                    
                    if (secondsLeft <= 0) {
                        clearInterval(timerInterval);
                        resendOtpBtn.disabled = false;
                        resendOtpBtn.textContent = 'Resend OTP';
                    }
                }, 1000);
            }
            
            function updateTimerDisplay() {
                const minutes = Math.floor(secondsLeft / 60);
                const seconds = secondsLeft % 60;
                timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                resendCountdown.textContent = secondsLeft;
            }
            
            // Email form submission
            emailForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const email = document.getElementById('email').value;
                
                sendOtpBtn.disabled = true;
                sendOtpBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
                
                try {
                    // Simulate API call - replace with actual fetch call
                    const response = await fetch('/send-password-reset-otp', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ email })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        // On success, move to OTP step
                        goToStep(2);
                        startTimer();
                    } else {
                        // Show error message
                        otpError.classList.remove('d-none');
                        otpErrorText.textContent = data.message || 'Failed to send OTP';
                    }
                } catch (error) {
                    console.error('Error:', error);
                    otpError.classList.remove('d-none');
                    otpErrorText.textContent = 'Network error. Please try again.';
                } finally {
                    sendOtpBtn.disabled = false;
                    sendOtpBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send OTP';
                }
            });
            
            // OTP form submission
            otpForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Combine OTP digits
                let otp = '';
                otpDigits.forEach(digit => {
                    otp += digit.value;
                });
                fullOtp.value = otp;
                
                if (otp.length !== 6) {
                    otpError.classList.remove('d-none');
                    otpErrorText.textContent = 'Please enter a 6-digit OTP';
                    return;
                }
                
                verifyOtpBtn.disabled = true;
                verifyOtpBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';
                
                try {
                    const email = document.getElementById('email').value;
                    
                    // Simulate API call - replace with actual fetch call
                    const response = await fetch('/verify-password-reset-otp', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ email, otp })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        // On success, move to password reset step
                        goToStep(3);
                    } else {
                        // Show error message
                        otpError.classList.remove('d-none');
                        otpErrorText.textContent = data.message || 'Invalid OTP';
                    }
                } catch (error) {
                    console.error('Error:', error);
                    otpError.classList.remove('d-none');
                    otpErrorText.textContent = 'Network error. Please try again.';
                } finally {
                    verifyOtpBtn.disabled = false;
                    verifyOtpBtn.innerHTML = '<i class="fas fa-check"></i> Verify OTP';
                }
            });
            
            // Resend OTP
            resendOtpBtn.addEventListener('click', async function() {
                if (this.disabled) return;
                
                this.disabled = true;
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Resending...';
                
                try {
                    const email = document.getElementById('email').value;
                    
                    // Simulate API call - replace with actual fetch call
                    const response = await fetch('/resend-password-reset-otp', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ email })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        // Reset OTP inputs
                        otpDigits.forEach(digit => {
                            digit.value = '';
                        });
                        otpDigits[0].focus();
                        
                        // Restart timer
                        startTimer();
                        
                        // Show success message
                        otpError.classList.add('d-none');
                    } else {
                        // Show error message
                        otpError.classList.remove('d-none');
                        otpErrorText.textContent = data.message || 'Failed to resend OTP';
                    }
                } catch (error) {
                    console.error('Error:', error);
                    otpError.classList.remove('d-none');
                    otpErrorText.textContent = 'Network error. Please try again.';
                } finally {
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-sync-alt"></i> Resend OTP';
                }
            });
            
            // Password form submission
            passwordForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                // Basic password validation
                if (newPassword.length < 8) {
                    passwordError.classList.remove('d-none');
                    passwordErrorText.textContent = 'Password must be at least 8 characters long';
                    return;
                }
                
                if (!/\d/.test(newPassword) || !/[!@#$%^&*]/.test(newPassword)) {
                    passwordError.classList.remove('d-none');
                    passwordErrorText.textContent = 'Password must contain at least 1 number and 1 special character';
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    passwordError.classList.remove('d-none');
                    passwordErrorText.textContent = 'Passwords do not match';
                    return;
                }
                
                resetPasswordBtn.disabled = true;
                resetPasswordBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Resetting...';
                
                try {
                    const email = document.getElementById('email').value;
                    
                    // Simulate API call - replace with actual fetch call
                    const response = await fetch('/reset-password', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ email, newPassword })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        // On success, show success message
                        goToStep(4);
                    } else {
                        // Show error message
                        passwordError.classList.remove('d-none');
                        passwordErrorText.textContent = data.message || 'Failed to reset password';
                    }
                } catch (error) {
                    console.error('Error:', error);
                    passwordError.classList.remove('d-none');
                    passwordErrorText.textContent = 'Network error. Please try again.';
                } finally {
                    resetPasswordBtn.disabled = false;
                    resetPasswordBtn.innerHTML = '<i class="fas fa-save"></i> Reset Password';
                }
            });
        });
    </script>
</body>
</html>